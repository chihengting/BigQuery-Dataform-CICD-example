name: è‡ªå‹•åŸ·è¡Œ Dataform SQLX

on:
  push:
    branches:
      - test

env:
  PROJECT_ID: jchuang-project
  LOCATION: asia-east1
  REPOSITORY: ding
  SERVICE_ACCOUNT_EMAIL: bigquery-pipeline-excutor@jchuang-project.iam.gserviceaccount.com

jobs:
  run-dataform:
    runs-on: ubuntu-latest
    steps:
      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: è¨­å®š Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Execute Dataform via REST API
        run: |
          echo "0. é©—è­‰ç¾åœ¨ç™»å…¥çš„ GCP å¸³è™Ÿèº«åˆ†ï¼š"
          gcloud config get-value account
          
          echo "1. å–å¾— Google Cloud Access Token..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          
          echo "2. å‘¼å« APIï¼šå»ºç«‹ Compilation Result (ç·¨è­¯æœ€æ–°çš„ test åˆ†æ”¯)..."
          COMPILATION_RESPONSE=$(curl -s -X POST "https://dataform.googleapis.com/v1/projects/${{ env.PROJECT_ID }}/locations/${{ env.LOCATION }}/repositories/${{ env.REPOSITORY }}/compilationResults" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"gitCommitish": "test"}')
            
          COMPILATION_RESULT=$(echo $COMPILATION_RESPONSE | jq -r '.name')
          
          if [ "$COMPILATION_RESULT" == "null" ] || [ -z "$COMPILATION_RESULT" ]; then
            echo "âŒ ç·¨è­¯å¤±æ•—ï¼API å›å‚³å…§å®¹ï¼š"
            echo $COMPILATION_RESPONSE
            exit 1
          fi
          
          echo "âœ… ç·¨è­¯æˆåŠŸï¼Compilation Result ID: $COMPILATION_RESULT"
          
          echo "3. å‘¼å« APIï¼šå»ºç«‹ Workflow Invocation (é–‹å§‹å°‡ SQL é€é€² BigQuery åŸ·è¡Œ)..."
          
          # ğŸ‘‡ ä¿®æ”¹é€™è£¡ï¼šä½¿ç”¨ jq å‹•æ…‹ç”Ÿæˆå¸¶æœ‰ serviceAccount çš„ JSON Payload
          PAYLOAD=$(jq -n \
            --arg comp "$COMPILATION_RESULT" \
            --arg sa "${{ env.SERVICE_ACCOUNT_EMAIL }}" \
            '{compilationResult: $comp, invocationConfig: {serviceAccount: $sa}}')

          # å¸¶å…¥ PAYLOAD å‘¼å« API
          INVOCATION_RESPONSE=$(curl -s -X POST "https://dataform.googleapis.com/v1/projects/${{ env.PROJECT_ID }}/locations/${{ env.LOCATION }}/repositories/${{ env.REPOSITORY }}/workflowInvocations" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          INVOCATION_ID=$(echo $INVOCATION_RESPONSE | jq -r '.name')
          
          if [ "$INVOCATION_ID" == "null" ] || [ -z "$INVOCATION_ID" ]; then
            echo "âŒ åŸ·è¡Œè§¸ç™¼å¤±æ•—ï¼API å›å‚³å…§å®¹ï¼š"
            echo $INVOCATION_RESPONSE
            exit 1
          fi
          
          echo "ğŸš€ Dataform åŸ·è¡Œå·²æˆåŠŸè§¸ç™¼ï¼Invocation ID: $INVOCATION_ID"