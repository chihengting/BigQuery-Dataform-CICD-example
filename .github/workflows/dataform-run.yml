name: è‡ªå‹•åŸ·è¡Œ Dataform SQLX

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: jchuang-project
  LOCATION: asia-east1
  REPOSITORY: BigQuery-Dataform-CICD-example
  SERVICE_ACCOUNT_EMAIL: bigquery-github-action@jchuang-project.iam.gserviceaccount.com
  TARGET_DATASET: ding_test

jobs:
  run-dataform:
    runs-on: ubuntu-latest
    steps:
      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é ˆè¨­ç‚º 0ï¼Œæ‰èƒ½æŠ“å–å®Œæ•´çš„ git æ­·å²ä¾†æ¯”å°å·®ç•°

      - name: åµæ¸¬æœ‰ç•°å‹•çš„ .sqlx æª”æ¡ˆ
        id: changed-files
        uses: tj-actions/changed-files@7dee1b0c1557f278e5c7dc244927139d78c0e22a
        with:
          files: '**/*.sqlx'
          separator: ' '

      - name: GCP æ¬Šé™é©—è­‰ (Authenticate to Google Cloud)
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: é€é REST API åŸ·è¡Œ Dataform
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "1. å–å¾— Google Cloud Access Token..."
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          
          echo "2. å‘¼å« APIï¼šå»ºç«‹ Compilation Result..."
          COMPILATION_RESPONSE=$(curl -s -X POST "https://dataform.googleapis.com/v1/projects/${{ env.PROJECT_ID }}/locations/${{ env.LOCATION }}/repositories/${{ env.REPOSITORY }}/compilationResults" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"gitCommitish\": \"${{ github.sha }}\"}")
            
          COMPILATION_RESULT=$(echo $COMPILATION_RESPONSE | jq -r '.name // empty')
          
          if [ -z "$COMPILATION_RESULT" ]; then
            echo "âŒ ç·¨è­¯å¤±æ•—ï¼"
            exit 1
          fi
          echo "âœ… ç·¨è­¯æˆåŠŸï¼Compilation ID: $COMPILATION_RESULT"
          
          echo "3. å‹•æ…‹çµ„åˆç•°å‹•æª”æ¡ˆçš„ Target æ¸…å–®..."
          TARGETS_JSON="[]"
          
          # è®€å–å‰›å‰›åµæ¸¬åˆ°çš„ç•°å‹•æª”æ¡ˆåˆ—è¡¨
          for FILE in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # æ“·å–æª”åï¼Œä¾‹å¦‚å¾ "definitions/test.sqlx" å–å‡º "test"
            TABLE_NAME=$(basename "$FILE" .sqlx)
            echo "ğŸ‘‰ åµæ¸¬åˆ°ç•°å‹•è¡¨: $TABLE_NAME"
            
            # å°‡é€™å€‹è¡¨è½‰æˆ API éœ€è¦çš„ JSON æ ¼å¼
            TARGET_JSON=$(jq -n \
              --arg db "${{ env.PROJECT_ID }}" \
              --arg schema "${{ env.TARGET_DATASET }}" \
              --arg name "$TABLE_NAME" \
              '{database: $db, schema: $schema, name: $name}')
            
            # å¡é€² Array è£¡
            TARGETS_JSON=$(echo "$TARGETS_JSON" | jq ". += [$TARGET_JSON]")
          done
          
          echo "ğŸ” ç”Ÿæˆçš„åŸ·è¡Œç›®æ¨™ï¼š"
          echo "$TARGETS_JSON"

          echo "4. å‘¼å« APIï¼šå»ºç«‹ Workflow Invocation (åªåŸ·è¡Œç•°å‹•æª”æ¡ˆ)..."
          
          # å°‡ Targets å¡å…¥ Payload ä¸­
          # transitiveDependenciesIncluded: true ä»£è¡¨å¦‚æœç•°å‹•äº† A è¡¨ï¼Œä¾è³´ A çš„ä¸‹æ¸¸è¡¨ä¹Ÿæœƒè·Ÿè‘—é‡è·‘ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
          PAYLOAD=$(jq -n \
            --arg comp "$COMPILATION_RESULT" \
            --arg sa "${{ env.SERVICE_ACCOUNT_EMAIL }}" \
            --argjson targets "$TARGETS_JSON" \
            '{
              compilationResult: $comp,
              invocationConfig: {
                serviceAccount: $sa,
                includedTargets: $targets,
                transitiveDependenciesIncluded: true
              }
            }')

          INVOCATION_RESPONSE=$(curl -s -X POST "https://dataform.googleapis.com/v1/projects/${{ env.PROJECT_ID }}/locations/${{ env.LOCATION }}/repositories/${{ env.REPOSITORY }}/workflowInvocations" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          INVOCATION_ID=$(echo $INVOCATION_RESPONSE | jq -r '.name // empty')
          
          if [ -z "$INVOCATION_ID" ]; then
            echo "âŒ åŸ·è¡Œè§¸ç™¼å¤±æ•—ï¼"
            echo "$INVOCATION_RESPONSE"
            exit 1
          fi
          echo "ğŸš€ åªåŸ·è¡Œç•°å‹•æª”æ¡ˆæˆåŠŸè§¸ç™¼ï¼Invocation ID: $INVOCATION_ID"